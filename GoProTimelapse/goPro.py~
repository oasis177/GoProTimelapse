#!/usr/bin/python

import commands
import urllib, requests
import time
import datetime
import os
import smtplib
import ftpBckup
from bs4 import BeautifulSoup
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from wifi import *
#LA PSWD DEL WIFI DE LA GOPRO ES Osim2000
Err = 0


def EnviarMail(option):
    #Opcion 0 para Connexion perdida
    #Opcion 1 para foto no guardada
    server = smtplib.SMTP('smtp.gmail.com',587)
    server.starttls()
    server.login("nil.micola@gmail.com","svicoracyy7175")
    msg = MIMEMultipart()
    msg['From'] = "nil.micola@gmail.com"
    msg['To'] = "antonio.donado@electroad.es"
    if option == 0:
          msg['Subject'] = "GoPro Connection LOST"
          text = "Se ha perdido la connexion de la GoPro"
    elif option == 1:
          msg['Subject'] = "GoPro couldn't save photo"
          text = "No se ha guardado la ultima foto de la GoPro" 
    part1 = MIMEText(text,'plain')
    msg.attach(part1)
    server.sendmail("nil.micola@gmail.com","antonio.donado@electroad.es",msg.as_string())
    server.sendmail("nil.micola@gmail.com","nil.micola@gmail.com",msg.as_string())
    server.quit()
    
def LastPhoto():
    url = 'http://10.5.5.9:8080/DCIM/999GOPRO/'
    lastImg = 0
    try:
       resp = requests.get(url,timeout = 90)
       soup = BeautifulSoup(resp.content,'html5lib')    
       for img in soup.findAll('a'):
           if '.JPG' in img.get('href') or '.jpg' in img.get('href'):
             try:
                numImg = int(img.get('href')[4:img.get('href').index('.')])
                if numImg > lastImg:
                    lastImg = numImg
             except Exception,e:
                EnviarMail(1)
                LogError = open('/home/pi/Desktop/goProPython/LogGoPro.txt','ab+')
                LogError.write("ERROR NO SAVED PHOTO: " + str(datetime.datetime.now()) + "\n")
                LogError.close()
 
    except Exception, e:
        EnviarMail(1)
        LogError = open('/home/pi/Desktop/goProPython/LogGoPro.txt','ab+')
        LogError.write("ERROR NO SAVED PHOTO: " + str(datetime.datetime.now()) + "\n")
        LogError.close() 
    return lastImg
               

def ComprovarBackup():
    try:     
        fdate = open('lastbackup.txt','a+')
        str1 = fdate.readline().strip()
        if (str1 == ""):
            fdate.write(str(datetime.datetime.now())+ "\n")
            ftpBckup.ftpBckup.load()
            fdate.close()
        else:
            try:
                date1 = datetime.datetime.strptime(str1,'%Y-%m-%d %H:%M:%S.%f')
                dateDif = datetime.datetime.now() - date1
                if (dateDif.seconds/3600) > 23:
                    fdate.close()
                    os.remove('lastbackup.txt')
                    fdate1 = open('lastbackup.txt','a+')
                    fdate1.write(str(datetime.datetime.now())+ "\n")
                    ftpBckup.ftpBckup.load()
                    fdate1.close()          
                else:
                    fdate.close() 
           
            except Exception,e:
                print e
    except Excption:
        pass

while(True):  
    try:  
        
        curr = datetime.datetime.now().time()
        ComprovarBackup()
        numimg = LastPhoto()
        if (curr.hour >= 6) and (curr.hour < 20):        
            page = urllib.urlopen("http://10.5.5.9/bacpac/PW?t=Osim2000&p=%01")
            time.sleep(05)
            page = urllib.urlopen("http://10.5.5.9/camera/CM?t=Osim2000&p=%01")
            time.sleep(05)
            page = urllib.urlopen("http://10.5.5.9/bacpac/SH?t=Osim2000&p=%01")
            time.sleep(05)
            #page = urllib.urlopen("http://10.5.5.9/bacpac/PW?t=Osim2000&p=%00")
            #today = datetime.datetime.now()
            
            Err = 0
            #print numimg
            numimg1 = LastPhoto()
            #print numimg1
            if numimg + 1 != numimg1:
                EnviarMail(1)
                LogError = open('/home/pi/Desktop/goProPython/LogGoPro.txt','ab+')
                LogError.write("ERROR NO SAVED PHOTO: " + str(datetime.datetime.now()) + "\n")
                LogError.close()
            else:
                LogError = open('/home/pi/Desktop/goProPython/LogGoPro.txt','ab+')
                LogError.write("Saved photo "+ str(numimg + 1) + ": " + str(datetime.datetime.now()) + "\n")
                LogError.close()
        time.sleep(1500)
    except KeyboardInterrupt:
        LogFile.close()
        break
    except IOError:
        Err += 1
        if (Err == 1):           
            EnviarMail(0)
            os.system("sudo ifconfig wlan0 down")
            time.sleep(2)
            os.system("sudo ifconfig wlan0 up")
            LogError = open('/home/pi/Desktop/goProPython/LogGoPro.txt','ab+')
            LogError.write("Error: " + str(datetime.datetime.now()) + "\n")
            LogError.write("Mail sent & Reset wlan: " + str(datetime.datetime.now()) + "\n")
            LogError.close()
        elif Err > 1 and Err < 8:
            os.system("sudo ifconfig wlan0 down")
            time.sleep(2)
            os.system("sudo ifconfig wlan0 up")
            LogError = open('/home/pi/Desktop/goProPython/LogGoPro.txt','ab+')
            LogError.write("Reset wlan: " + str(datetime.datetime.now()) + "\n")
            LogError.close()
        elif Err >= 8:
            LogError = open('/home/pi/Desktop/goProPython/LogGoPro.txt','ab+')
            LogError.write("Reset Raspberry: " + str(datetime.datetime.now()) + "\n")
            LogError.close()
            os.system("sudo shutdown -r now")
        #TEST = Scheme.find('wlan0','NIL')
        #TEST.activate()     
        time.sleep(500)
        

    
